{% load static %}

{% load static %}
<html>
<link rel="stylesheet" href="{% static 'core/plugins/bootstrap/css/bootstrap.min.css' %}">
<script src="{% static 'core/plugins/jquery/jquery.min.js' %}"></script>
<script src="{% static 'causalmodel/js/go-debug.js' %}"></script>

<style type="text/css" media="print">
    @page
    {
        size: auto;
        margin: 0mm;
    }
</style>

<body style="padding: .25in;">

<div class="row">

    <div class="col-2">
        <img src="{% static 'core/images/com.png' %}" style="width: 85%; padding-top: 19px" class="brand-image img-circle">
    </div>
    <div class="col-5">
        <h3 style="padding-top: 30px;">Mandaluyong City</h3>
        <h3 style="padding: 0px;">Nutrition Committee</h3>
        <h4 style="padding: 0px;">Causal Model for Year {{ year }}</h4>
    </div>
    <div class="col-5" style="text-align: right;">
        <p style="padding-top: 30px; margin: 0px;">Report Generated on:</p>
        <p style="margin: 0px;">Date: {% now "F d, Y" %} </p>
        <p style="margin: 0px;">Time: {% now "g: s A" %}</p>
        <p style="margin: 0px;">Generated By: {{ causal_model.uploaded_by.get_name }} ({{ causal_model.uploaded_by.user_type }})</p>
    </div>
</div>

<hr>
<div id="testdiv"></div>


<script>
    $(function() {



        $.ajax({
            url: "/causal-models/details2",
            type: "post",
            data: {
              'year': {{ causal_model.date.year }}
            },
            dataType: "json",
            success: function(data) {

                // tree

                var GO = go.GraphObject.make;

                var diagram = GO(go.Diagram, "tree", { layout: GO(go.TreeLayout, { angle: 90,  layerSpacing: 70, nodeSpacing: 5 }), initialAutoScale: go.Diagram.Uniform });
                var myModel = GO(go.TreeModel);


                myModel.nodeDataArray = data.data;

                diagram.model = myModel;

                diagram.nodeTemplate =
                   GO(go.Node, "Vertical",{ maxSize: new go.Size(350,300),fromSpot: go.Spot.Bottom,  toSpot: go.Spot.Top },
                       GO(go.Panel, "Vertical", { background: "#f4f5f7", padding: 10 },
                           GO(go.TextBlock, new go.Binding("text", "name"), { font: "bold 19pt Arial", maxSize: new go.Size(350, 300)}),
                           GO(go.Panel, "Vertical", new go.Binding("itemArray", "quantifiable_data"),
                               {
                                   itemTemplate:
                                       GO(go.Panel, "Auto",
                                        { margin: 2 },
                                       GO(go.TextBlock, new go.Binding("text", ""),
                                        { margin: 2, font: "italic bold 15pt Arial", stroke: "red", maxSize: new go.Size(320, 300) })
                                    )
                               }
                           )
                       )
                   );

                    diagram.linkTemplate =
                    GO(go.Link,
                    { routing: go.Link.Orthogonal,  // Orthogonal routing
                    corner: 10 },                 // with rounded corners
                    GO(go.Shape),
                    GO(go.Shape, { toArrow: "Standard" })
                    );
                   console.log("test");
                img = diagram.makeImage();
                $('#testdiv').append(img);
                console.log(img);
                $('#tree').remove();
                },
            error: function(data) {
                console.log(data.responseText);
            }
        });

    });

    function getCookie(name) {

        var cookieValue = null;

        if (document.cookie && document.cookie != '') {

            var cookies = document.cookie.split(';');

            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

        var csrftoken = getCookie('csrftoken');

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
</script>

<div id="tree" style="height: 500px; width: 1010px; border: 1px solid black;">

</div>

</body>
<script type="text/javascript">
$( document ).ready(function() {
setTimeout(function() {
    window.print();
}, 1000);
window.onfocus = function(){ window.close();}
});
</script>

</html>